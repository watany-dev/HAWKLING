# パフォーマンス改善レビュー

## 現状の問題点

1. `main.go` における不必要なフィルタリングの重複
2. AWS APIリクエストの非効率な使用
3. スライスの初期化方法が非効率
4. フォーマッタにおけるメモリ使用の最適化不足

## 改善提案

### 1. フィルタリングロジックの最適化 (main.go)

現在、`listRoles`関数では複数のフィルタ条件（days, onlyUsed, onlyUnused）がそれぞれ独立して適用されており、複数回のスライス走査が発生しています。これを1回の走査で済むように最適化できます。

```go
// 改善前: 複数回のフィルタリングループ
if days > 0 { /* フィルタリング処理 */ }
if onlyUsed { /* フィルタリング処理 */ }
if onlyUnused { /* フィルタリング処理 */ }

// 改善後: 1回のループで全条件を評価
var filteredRoles []aws.Role
for _, role := range roles {
    if (days > 0 && !role.IsUnused(days)) ||
       (onlyUsed && role.LastUsed == nil) ||
       (onlyUnused && role.LastUsed != nil) {
        continue
    }
    filteredRoles = append(filteredRoles, role)
}
```

### 2. AWS APIリクエストの最適化 (awsclient.go)

`ListRoles`メソッドでは現在、ロールの取得とロールの最終使用日時の取得が分離されています。AWS APIが提供する情報を最大限活用することで、APIコールを減らせる可能性があります。

また、ゴルーチンの起動方法を改善することでオーバーヘッドを減らせます。

```go
// 改善前: ゴルーチン起動のオーバーヘッド
for i := range roles {
    go func(i int) {
        // ...
    }(i)
}

// 改善後: ワーカープールパターンの採用
```

### 3. スライス初期化の最適化

多くの場所でスライスが事前容量指定なしで初期化されています。容量を事前に指定することで、動的な拡張によるメモリ割り当てを減らせます。

```go
// 改善前
var unusedRoles []aws.Role

// 改善後
unusedRoles := make([]aws.Role, 0, len(roles))
```

### 4. formatter.goのメモリ使用最適化

`FormatRolesAsJSON`関数では、すべてのロール情報がJSONとしてメモリに格納されてから出力されます。大量のロールがある場合、ストリーミング方式の出力に変更することで、メモリ使用量を削減できます。

## 実装優先度

1. **高**: スライス初期化の最適化（実装が容易かつ効果が明確）
2. **中**: フィルタリングロジックの統合（コード可読性を維持しつつ改善）
3. **中**: ゴルーチン管理の最適化（現状でもセマフォがあり基本的には問題ない）
4. **低**: JSONフォーマッタのストリーミング出力（大量データ時のみ効果あり）

これらの改善により、メモリ使用量の削減とCPU使用効率の向上が期待できます。特に大量のロールを処理する場合に効果が顕著になるでしょう。